const readlineSync = require("readline-sync");
const VendingMachine = require("./VendingMachine");

/**
 * Interface utilisateur console pour le distributeur automatique
 */
class ConsoleUI {
  constructor() {
    this.vendingMachine = new VendingMachine();
    this.vendingMachine.initialize();
  }

  /**
   * D√©marre l'interface utilisateur
   */
  start() {
    console.log("\nüé∞ === DISTRIBUTEUR AUTOMATIQUE === üé∞\n");
    console.log(
      "Bienvenue ! Choisissez votre produit et ins√©rez votre argent.\n"
    );

    while (true) {
      this.showMainMenu();
      const choice = readlineSync.question("Votre choix: ");

      switch (choice) {
        case "1":
          this.showProducts();
          break;
        case "2":
          this.selectProduct();
          break;
        case "3":
          this.insertMoney();
          break;
        case "4":
          this.purchase();
          break;
        case "5":
          this.cancel();
          break;
        case "6":
          this.showStatus();
          break;
        case "7":
          this.adminMenu();
          break;
        case "8":
          this.showStatistics();
          break;
        case "0":
          console.log(
            "\nMerci d'avoir utilis√© notre distributeur ! Au revoir ! üëã\n"
          );
          return;
        default:
          console.log("\n‚ùå Choix invalide. Veuillez r√©essayer.\n");
      }
    }
  }

  /**
   * Affiche le menu principal
   */
  showMainMenu() {
    const status = this.vendingMachine.getStatus();

    console.log("=".repeat(50));
    console.log("üí∞ Argent ins√©r√©:", status.insertedMoneyFormatted);
    console.log(
      "üì¶ Produit s√©lectionn√©:",
      status.selectedProduct
        ? `${status.selectedProduct.name} (${status.selectedProduct.priceFormatted})`
        : "Aucun"
    );
    console.log("=".repeat(50));
    console.log("1. üìã Voir les produits disponibles");
    console.log("2. üéØ S√©lectionner un produit");
    console.log("3. üíµ Ins√©rer de l'argent");
    console.log("4. üõí Acheter");
    console.log("5. ‚ùå Annuler et r√©cup√©rer l'argent");
    console.log("6. üìä Voir l'√©tat de la machine");
    console.log("7. üîß Menu administrateur");
    console.log("8. üìà Statistiques");
    console.log("0. üö™ Quitter");
    console.log("=".repeat(50));
  }

  /**
   * Affiche la liste des produits
   */
  showProducts() {
    const status = this.vendingMachine.getStatus();

    console.log("\nüì¶ === PRODUITS DISPONIBLES === üì¶\n");

    if (status.availableProducts.length === 0) {
      console.log("‚ùå Aucun produit disponible actuellement.\n");
      return;
    }

    console.log("Code | Produit       | Prix     | Stock");
    console.log("-".repeat(40));

    status.availableProducts.forEach((product) => {
      console.log(
        `${product.id.padEnd(4)} | ${product.name.padEnd(
          13
        )} | ${product.priceFormatted.padEnd(8)} | ${product.quantity}`
      );
    });

    console.log("\n");
  }

  /**
   * S√©lectionne un produit
   */
  selectProduct() {
    this.showProducts();

    const productId = readlineSync
      .question("Entrez le code du produit: ")
      .toUpperCase();
    const result = this.vendingMachine.selectProduct(productId);

    if (result.success) {
      console.log(`\n‚úÖ ${result.message}`);
      console.log(`üí∞ Prix: ${result.product.priceFormatted}\n`);
    } else {
      console.log(`\n‚ùå ${result.message}\n`);
    }
  }

  /**
   * Ins√®re de l'argent
   */
  insertMoney() {
    console.log("\nüíµ === INS√âRER DE L'ARGENT === üíµ\n");
    console.log("D√©nominations accept√©es:");
    console.log("1 = 0,01‚Ç¨  |  2 = 0,02‚Ç¨  |  5 = 0,05‚Ç¨  |  10 = 0,10‚Ç¨");
    console.log("20 = 0,20‚Ç¨ |  50 = 0,50‚Ç¨ |  100 = 1,00‚Ç¨ |  200 = 2,00‚Ç¨");
    console.log(
      "500 = 5,00‚Ç¨ | 1000 = 10,00‚Ç¨ | 2000 = 20,00‚Ç¨ | 5000 = 50,00‚Ç¨\n"
    );

    const input = readlineSync.question(
      "Entrez la valeur en centimes (ou 0 pour retour): "
    );
    const amount = parseInt(input);

    if (amount === 0) return;

    if (isNaN(amount) || amount < 0) {
      console.log("\n‚ùå Montant invalide.\n");
      return;
    }

    const result = this.vendingMachine.insertMoney(amount);

    if (result.success) {
      console.log(`\n‚úÖ ${result.message}`);
      console.log(`üí∞ Total ins√©r√©: ${result.totalInsertedFormatted}\n`);
    } else {
      console.log(`\n‚ùå ${result.message}\n`);
    }
  }

  /**
   * Effectue l'achat
   */
  purchase() {
    const result = this.vendingMachine.purchase();

    if (result.success) {
      console.log(`\nüéâ ${result.message}`);
      console.log(`üì¶ Produit: ${result.product.name}`);

      if (result.change > 0) {
        console.log(`üí∞ Monnaie rendue: ${result.changeFormatted}`);
        console.log("D√©tail de la monnaie:");
        result.changeCoins.forEach((coin) => {
          console.log(`  ${coin.count}x ${coin.formatted}`);
        });
      }
      console.log("\nMerci pour votre achat ! üòä\n");
    } else {
      console.log(`\n‚ùå ${result.message}\n`);
    }
  }

  /**
   * Annule la transaction
   */
  cancel() {
    const result = this.vendingMachine.cancel();

    if (result.success) {
      console.log(`\n‚úÖ ${result.message}`);
      console.log(`üí∞ Argent rendu: ${result.refundFormatted}`);

      if (result.refundCoins.length > 0) {
        console.log("D√©tail du remboursement:");
        result.refundCoins.forEach((coin) => {
          console.log(`  ${coin.count}x ${coin.formatted}`);
        });
      }
      console.log();
    } else {
      console.log(`\n‚ùå ${result.message}\n`);
    }
  }

  /**
   * Affiche l'√©tat de la machine
   */
  showStatus() {
    const status = this.vendingMachine.getStatus();

    console.log("\nüìä === √âTAT DE LA MACHINE === üìä\n");
    console.log(`üí∞ Argent ins√©r√©: ${status.insertedMoneyFormatted}`);
    console.log(
      `üì¶ Produit s√©lectionn√©: ${
        status.selectedProduct
          ? `${status.selectedProduct.name} (${status.selectedProduct.priceFormatted})`
          : "Aucun"
      }`
    );
    console.log(`üè¶ Total dans la machine: ${status.totalMoneyFormatted}`);

    console.log("\nüì¶ Inventaire:");
    console.log("Code | Produit       | Prix     | Stock");
    console.log("-".repeat(40));

    const allProducts = this.vendingMachine.inventory.getAllProducts();
    allProducts.forEach((product) => {
      const available = product.quantity > 0 ? "‚úÖ" : "‚ùå";
      console.log(
        `${product.id.padEnd(4)} | ${product.name.padEnd(
          13
        )} | ${this.vendingMachine.coinManager
          .formatAmount(product.price)
          .padEnd(8)} | ${product.quantity} ${available}`
      );
    });

    console.log("\n");
  }

  /**
   * Menu administrateur
   */
  adminMenu() {
    while (true) {
      console.log("\nüîß === MENU ADMINISTRATEUR === üîß\n");
      console.log("1. üì¶ R√©approvisionner un produit");
      console.log("2. üí∞ Ajouter de la monnaie");
      console.log("3. üìà Voir les statistiques d√©taill√©es");
      console.log("4. üìã Historique des transactions");
      console.log("0. üîô Retour au menu principal");
      console.log("=".repeat(40));

      const choice = readlineSync.question("Votre choix: ");

      switch (choice) {
        case "1":
          this.restockProduct();
          break;
        case "2":
          this.addCoins();
          break;
        case "3":
          this.showDetailedStatistics();
          break;
        case "4":
          this.showTransactionHistory();
          break;
        case "0":
          return;
        default:
          console.log("\n‚ùå Choix invalide.\n");
      }
    }
  }

  /**
   * R√©approvisionne un produit
   */
  restockProduct() {
    this.showStatus();

    const productId = readlineSync
      .question("Code du produit √† r√©approvisionner: ")
      .toUpperCase();
    const quantity = parseInt(readlineSync.question("Quantit√© √† ajouter: "));

    if (isNaN(quantity) || quantity <= 0) {
      console.log("\n‚ùå Quantit√© invalide.\n");
      return;
    }

    const result = this.vendingMachine.restockProduct(productId, quantity);
    console.log(`\n${result.success ? "‚úÖ" : "‚ùå"} ${result.message}\n`);
  }

  /**
   * Ajoute de la monnaie
   */
  addCoins() {
    console.log("\nüí∞ === AJOUTER DE LA MONNAIE === üí∞\n");

    const denomination = parseInt(
      readlineSync.question("D√©nomination (en centimes): ")
    );
    const count = parseInt(readlineSync.question("Nombre de pi√®ces/billets: "));

    if (isNaN(denomination) || isNaN(count) || count <= 0) {
      console.log("\n‚ùå Valeurs invalides.\n");
      return;
    }

    const result = this.vendingMachine.addCoins(denomination, count);
    console.log(`\n${result.success ? "‚úÖ" : "‚ùå"} ${result.message}\n`);
  }

  /**
   * Affiche les statistiques d√©taill√©es
   */
  showDetailedStatistics() {
    const stats = this.vendingMachine.getStatistics();

    console.log("\nüìà === STATISTIQUES D√âTAILL√âES === üìà\n");
    console.log(`üìä Total des transactions: ${stats.totalTransactions}`);
    console.log(`‚úÖ Ventes r√©ussies: ${stats.successfulSales}`);
    console.log(
      `üí∞ Chiffre d'affaires: ${this.vendingMachine.coinManager.formatAmount(
        stats.totalRevenue
      )}`
    );
    console.log(`‚ùå Erreurs: ${stats.errors}`);
    console.log(`üîÑ Annulations: ${stats.cancellations}`);
    console.log(`üìà Taux de r√©ussite: ${stats.successRate}`);
    console.log("\n");
  }

  /**
   * Affiche l'historique des transactions
   */
  showTransactionHistory() {
    const transactions = this.vendingMachine.getTransactionHistory();

    console.log("\nüìã === HISTORIQUE DES TRANSACTIONS === üìã\n");

    if (transactions.length === 0) {
      console.log("Aucune transaction enregistr√©e.\n");
      return;
    }

    console.log("Date/Heure          | Type    | Produit | Montant  | Statut");
    console.log("-".repeat(65));

    transactions.slice(-20).forEach((transaction) => {
      const date = transaction.timestamp.toLocaleString();
      const type = transaction.type.padEnd(7);
      const product = (transaction.productId || "-").padEnd(7);
      const amount = this.vendingMachine.coinManager
        .formatAmount(transaction.amount)
        .padEnd(8);
      const status = transaction.success ? "‚úÖ" : "‚ùå";

      console.log(`${date} | ${type} | ${product} | ${amount} | ${status}`);
    });

    if (transactions.length > 20) {
      console.log(
        `\n... et ${transactions.length - 20} transactions plus anciennes`
      );
    }

    console.log("\n");
  }

  /**
   * Affiche les statistiques simples
   */
  showStatistics() {
    const stats = this.vendingMachine.getStatistics();

    console.log("\nüìà === STATISTIQUES === üìà\n");
    console.log(`üìä Total des transactions: ${stats.totalTransactions}`);
    console.log(`‚úÖ Ventes r√©ussies: ${stats.successfulSales}`);
    console.log(
      `üí∞ Chiffre d'affaires: ${this.vendingMachine.coinManager.formatAmount(
        stats.totalRevenue
      )}`
    );
    console.log(`üìà Taux de r√©ussite: ${stats.successRate}`);
    console.log("\n");
  }
}

module.exports = ConsoleUI;
